<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lost & Found - Sửa tin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="./app.css" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar lf-navbar">
      <div class="container py-2">
        <a class="navbar-brand fw-bold" href="/index.html">Lost & Found</a>
        <div class="d-flex gap-2 align-items-center">
          <a class="btn btn-outline-secondary btn-sm" href="./create.html">Đăng tin</a>
          <a class="btn btn-outline-secondary btn-sm" href="./my.html">Tin của tôi</a>
          <a class="btn btn-outline-primary btn-sm" data-lf-login href="./login.html">Đăng nhập</a>
          <a class="btn btn-outline-danger btn-sm d-none" data-lf-logout href="#">Đăng xuất</a>
          <span class="small lf-muted ms-2" data-lf-user></span>
        </div>
      </div>
    </nav>

    <main class="container my-4" style="max-width: 980px;">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h4 class="mb-0">Sửa tin</h4>
        <a class="btn btn-outline-secondary btn-sm" href="./my.html">Quay lại</a>
      </div>

      <div id="alert" class="alert alert-danger d-none"></div>
      <div id="loading" class="lf-card p-4">Đang tải...</div>

      <div class="lf-card p-3 d-none" id="wrap">
        <form id="form">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Loại</label>
              <select class="form-select" id="type">
                <option value="LOST">Đồ bị mất</option>
                <option value="FOUND">Đồ nhặt được</option>
              </select>
            </div>
            <div class="col-12 col-md-8">
              <label class="form-label">Tiêu đề</label>
              <input class="form-control" id="title" maxlength="200" required />
            </div>

            <div class="col-12">
              <label class="form-label">Mô tả</label>
              <textarea class="form-control" id="description" rows="3"></textarea>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Category</label>
              <input class="form-control" id="category" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Màu</label>
              <input class="form-control" id="color" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Hãng</label>
              <input class="form-control" id="brand" />
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Dấu hiệu nhận biết</label>
              <input class="form-control" id="distinctive_marks" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Ngày mất/nhặt (YYYY-MM-DD)</label>
              <input class="form-control" id="lost_found_date" />
            </div>

            <div class="col-12">
              <label class="form-label">Địa điểm</label>
              <input class="form-control" id="location_text" required />
            </div>

            <div class="col-12">
              <div class="lf-form-help">
                Lưu ý: backend hiện chưa hỗ trợ cập nhật <code>image_public_ids</code> trong PATCH, nên trang này chỉ sửa text fields.
              </div>
            </div>

            <div class="col-12 d-flex gap-2">
              <button class="btn btn-primary" id="btnSubmit" type="submit">Lưu</button>
              <a class="btn btn-outline-secondary" id="btnDetail" href="#">Xem chi tiết</a>
            </div>
          </div>
        </form>
      </div>
    </main>

    <script src="./app.js"></script>
    <script>
      if (!LF.requireAuth("./login.html")) {}
      LF.wireNavbar();

      const elAlert = document.getElementById("alert");
      const elLoading = document.getElementById("loading");
      const elWrap = document.getElementById("wrap");
      const btn = document.getElementById("btnSubmit");
      let currentId = null;

      function showError(msg) {
        elAlert.classList.remove("d-none");
        elAlert.textContent = msg;
      }
      function clearError() {
        elAlert.classList.add("d-none");
        elAlert.textContent = "";
      }

      function getId() {
        // Ưu tiên lấy từ query string ?id=...
        let search = location.search;
        if (!search && location.hash && location.hash.includes("id=")) {
          // fallback: cho trường hợp id nằm trong hash #id=...
          search = "?" + location.hash.slice(1);
        }
        const p = new URLSearchParams(search);
        return p.get("id");
      }

      function setVal(id, v) {
        const el = document.getElementById(id);
        if (el) el.value = v ?? "";
      }

      async function load() {
        currentId = getId();
        if (!currentId) {
          // Nếu thiếu id thì quay lại danh sách "Tin của tôi"
          window.location.href = "/app/my.html";
          return;
        }
        document.getElementById("btnDetail").href = `/app/detail?id=${encodeURIComponent(currentId)}`;
        try {
          const item = await LF.getItem(currentId);
          setVal("type", item.type);
          setVal("title", item.title);
          setVal("description", item.description);
          setVal("category", item.category);
          setVal("color", item.color);
          setVal("brand", item.brand);
          setVal("distinctive_marks", item.distinctive_marks);
          setVal("lost_found_date", item.lost_found_date ? String(item.lost_found_date).slice(0, 10) : "");
          setVal("location_text", item.location_text);

          elLoading.classList.add("d-none");
          elWrap.classList.remove("d-none");
        } catch (e) {
          elLoading.classList.add("d-none");
          showError(e?.message || "Không tải được bài");
        }
      }

      document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        clearError();
        if (!currentId) return;

        const payload = {
          type: document.getElementById("type").value,
          title: document.getElementById("title").value.trim(),
          description: document.getElementById("description").value.trim(),
          category: document.getElementById("category").value.trim(),
          color: document.getElementById("color").value.trim(),
          brand: document.getElementById("brand").value.trim(),
          distinctive_marks: document.getElementById("distinctive_marks").value.trim(),
          lost_found_date: document.getElementById("lost_found_date").value.trim(),
          location_text: document.getElementById("location_text").value.trim(),
        };
        Object.keys(payload).forEach((k) => {
          if (payload[k] === "") delete payload[k];
        });

        btn.disabled = true;
        btn.textContent = "Đang lưu...";
        try {
          await LF.updateItem(currentId, payload);
          window.location.href = `/app/detail?id=${encodeURIComponent(currentId)}`;
        } catch (err) {
          showError(err?.message || "Không lưu được");
        } finally {
          btn.disabled = false;
          btn.textContent = "Lưu";
        }
      });

      load();
    </script>
  </body>
</html>

