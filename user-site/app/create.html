<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lost & Found - Đăng tin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="./app.css" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar lf-navbar">
      <div class="container py-2">
        <a class="navbar-brand fw-bold" href="/index.html">Lost & Found</a>
        <div class="d-flex gap-2 align-items-center">
          <a class="btn btn-outline-secondary btn-sm" href="./create.html">Đăng tin</a>
          <a class="btn btn-outline-secondary btn-sm" href="./my.html">Tin của tôi</a>
          <a class="btn btn-outline-primary btn-sm" data-lf-login href="./login.html">Đăng nhập</a>
          <a class="btn btn-outline-danger btn-sm d-none" data-lf-logout href="#">Đăng xuất</a>
          <span class="small lf-muted ms-2" data-lf-user></span>
        </div>
      </div>
    </nav>

    <main class="container my-4" style="max-width: 980px;">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h4 class="mb-0">Đăng tin Lost/Found</h4>
        <a class="btn btn-outline-secondary btn-sm" href="./my.html">Quản lý tin</a>
      </div>

      <div id="alert" class="alert alert-danger d-none"></div>

      <div class="lf-card p-3">
        <form id="form">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Loại</label>
              <select class="form-select" id="type" required>
                <option value="LOST">Đồ bị mất</option>
                <option value="FOUND">Đồ nhặt được</option>
              </select>
            </div>
            <div class="col-12 col-md-8">
              <label class="form-label">Tiêu đề</label>
              <input class="form-control" id="title" maxlength="200" required placeholder="Ví dụ: Ví da màu nâu" />
              <div class="lf-form-help mt-1">Tối đa 200 ký tự.</div>
            </div>

            <div class="col-12">
              <label class="form-label">Mô tả</label>
              <textarea class="form-control" id="description" rows="3" placeholder="Mô tả chi tiết..."></textarea>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Category</label>
              <input class="form-control" id="category" placeholder="Ví dụ: Wallet" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Màu</label>
              <input class="form-control" id="color" placeholder="Ví dụ: nâu" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Hãng</label>
              <input class="form-control" id="brand" placeholder="Ví dụ: Samsung" />
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Dấu hiệu nhận biết</label>
              <input class="form-control" id="distinctive_marks" placeholder="Ví dụ: có vết xước góc trái" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Ngày mất/nhặt (YYYY-MM-DD)</label>
              <input class="form-control" id="lost_found_date" placeholder="2026-02-16" />
            </div>

            <div class="col-12">
              <label class="form-label">Địa điểm</label>
              <input class="form-control" id="location_text" required placeholder="Ví dụ: Tòa A, căng tin..." />
              <div class="lf-form-help mt-1">Backend đang dùng field <code>location_text</code> để lọc theo location.</div>
            </div>

            <div class="col-12">
              <label class="form-label">Ảnh (tối đa 5)</label>
              <input class="form-control" id="images" type="file" accept="image/*" multiple />
              <div class="lf-form-help mt-1">Ảnh sẽ upload lên Cloudinary qua API <code>/api/items/upload-image</code>.</div>
              <div id="previews" class="lf-preview-grid mt-3"></div>
            </div>

            <div class="col-12 d-flex gap-2">
              <button class="btn btn-primary" id="btnSubmit" type="submit">Đăng tin</button>
              <a class="btn btn-outline-secondary" href="./index.html">Hủy</a>
            </div>
          </div>
        </form>
      </div>
    </main>

    <script src="./app.js"></script>
    <script>
      if (!LF.requireAuth("./login.html")) {}
      LF.wireNavbar();

      const elAlert = document.getElementById("alert");
      const elImages = document.getElementById("images");
      const elPreviews = document.getElementById("previews");
      const btn = document.getElementById("btnSubmit");

      function showError(msg) {
        elAlert.classList.remove("d-none");
        elAlert.textContent = msg;
      }
      function clearError() {
        elAlert.classList.add("d-none");
        elAlert.textContent = "";
      }

      function renderPreviews(files) {
        elPreviews.innerHTML = "";
        const list = Array.from(files || []).slice(0, 5);
        list.forEach((f, idx) => {
          const url = URL.createObjectURL(f);
          const div = document.createElement("div");
          div.className = "lf-preview";
          div.innerHTML = `<img src="${url}" alt="preview ${idx+1}"><div class="lf-preview-tag">#${idx+1}</div>`;
          elPreviews.appendChild(div);
        });
      }

      elImages.addEventListener("change", () => {
        renderPreviews(elImages.files);
      });

      document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        clearError();

        const location = document.getElementById("location_text").value.trim();
        if (!location) {
          showError("Địa điểm không được để trống");
          return;
        }

        btn.disabled = true;
        btn.textContent = "Đang upload ảnh...";
        try {
          const files = Array.from(elImages.files || []).slice(0, 5);
          const images = [];
          const image_public_ids = [];

          for (const f of files) {
            const r = await LF.uploadImage(f);
            images.push(r.url);
            image_public_ids.push(r.publicId);
          }

          btn.textContent = "Đang tạo bài...";
          const payload = {
            type: document.getElementById("type").value,
            title: document.getElementById("title").value.trim(),
            description: document.getElementById("description").value.trim(),
            category: document.getElementById("category").value.trim(),
            color: document.getElementById("color").value.trim(),
            brand: document.getElementById("brand").value.trim(),
            distinctive_marks: document.getElementById("distinctive_marks").value.trim(),
            lost_found_date: document.getElementById("lost_found_date").value.trim(),
            location_text: location,
            images,
            image_public_ids,
          };

          // remove empty strings (optional fields)
          Object.keys(payload).forEach((k) => {
            if (payload[k] === "") delete payload[k];
          });

          const created = await LF.createItem(payload);
          const id = created?._id || created?.id;
          // Chuyển sang trang chi tiết với URL dạng /app/detail?id=...
          window.location.href = id
            ? `/app/detail?id=${encodeURIComponent(id)}`
            : `/app/my.html`;
        } catch (err) {
          showError(err?.message || "Không tạo được bài");
        } finally {
          btn.disabled = false;
          btn.textContent = "Đăng tin";
        }
      });
    </script>
  </body>
</html>

